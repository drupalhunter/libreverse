#include "Entry_Point_Detector.h"
#include "libreverse/meta/Meta_Object.h"
#include "libreverse/infrastructure/data_source/Data_Source_Factory.h"
#include <iostream>
#include "libreverse/io/input/File_Readers/Reader_Factory.h"
#include "libreverse/io/input/File_Readers/File_Reader.h"
#include "libreverse/data_containers/Filename.h"
#include "libreverse/infrastructure/data_source/Data_Object.h"
#include "libreverse/infrastructure/Component_Data.h"
#include "libreverse/infrastructure/Component_State.h"
#include <boost/format.hpp>
#include "libreverse/errors/API_Exception.h"
#include "libreverse/Trace.h"

using namespace libreverse::api;
using namespace libreverse::trace;

namespace libreverse { namespace component {

    const std::string Entry_Point_Detector::m_name = "Entry_Point_Detector";

    Entry_Point_Detector::Entry_Point_Detector ()
        : m_state_ptr ( new infrastructure::Component_State (0) )
    {
        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Inside Entry_Point_Detector constructor (id=%d)")
                           % m_state_ptr->get_ID() ) );
    }

    Entry_Point_Detector::Entry_Point_Detector ( infrastructure_types::Component_State::ptr_t state_ptr )
        : m_state_ptr ( state_ptr )
    {
        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Inside Entry_Point_Detector constructor (id=%d)")
                           % m_state_ptr->get_ID() ) );
    }

    Entry_Point_Detector::Entry_Point_Detector ( Entry_Point_Detector const& rhs)
        : infrastructure::Component ( rhs ),
          infrastructure::Component_Actor ( rhs ),
          boost::enable_shared_from_this<Entry_Point_Detector> ( rhs ),
          m_state_ptr ( new infrastructure::Component_State ( *rhs.m_state_ptr ) )
    {
        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Inside Entry_Point_Detector copy constructor (id=%d)")
                           % m_state_ptr->get_ID() ) );
    }

    Entry_Point_Detector::~Entry_Point_Detector ()
    {
        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Inside Entry_Point_Detector destructor (id=%d)")
                           % m_state_ptr->get_ID() ) );
    }

    void
    Entry_Point_Detector::received_Input_Source_Data ( boost::uint32_t id )
    {
        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Entering Entry_Point_Detector::received_Input_Source_Data (id=%d)")
                           % m_state_ptr->get_ID() ) );

        std::cout <<
            boost::format("Entry_Point_Detector(%d)::init")
            % m_state_ptr->get_ID()
                  << std::endl;


        m_state_ptr->received_Input_Source_Data ( id );

        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Exiting Entry_Point_Detector::received_Input_Source_Data (id=%d)")
                           % m_state_ptr->get_ID() ) );

    }

    void
    Entry_Point_Detector::add_Input_Source ( boost::uint32_t id )
    {
        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Inside Entry_Point_Detector::add_Input_Source (id=%d)")
                           % m_state_ptr->get_ID() ) );

        m_state_ptr->add_Input_Source ( id );
    }

    std::string
    Entry_Point_Detector::get_Name (void) const
    {
        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Inside Entry_Point_Detector::get_Name (id=%d)")
                           % m_state_ptr->get_ID() ) );

        return m_name;
    }

    void Entry_Point_Detector::process ()
    {
        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Entering Entry_Point_Detector::process (id=%d)")
                           % m_state_ptr->get_ID() ) );

        infrastructure_types::Component_Data::ptr_t data_ptr =
            m_state_ptr->get_Data();

        if ( ! data_ptr->is_Filename_Set() )
            {
                Trace::write_Trace
                    ( TraceArea::COMPONENTS,
                      TraceLevel::ERROR,
                      "Unable to find the input file name." );

                Trace::write_Trace
                    ( TraceArea::COMPONENTS,
                      TraceLevel::ERROR,
                      "Cannot find the arch type without it." );

                Trace::write_Trace
                    ( TraceArea::COMPONENTS,
                      TraceLevel::ERROR,
                      boost::str ( boost::format("Exception throw in %s at line %d")
                                   % __FILE__
                                   % __LINE__ ) );

                // At this point we have not found the filename somehow
                // the Precondition visitor did not work. So we will
                // will throw an exception
                throw ( errors::API_Exception
                        ( errors::API_Exception::INTERNAL_LIBRARY_ERROR ) );
            }

        data_types::Filename::const_ptr_t file_ptr =
            data_ptr->get_Input_Filename();

        io::File_Reader::ptr_t file_reader_ptr =
            ( io::Reader_Factory::Instance() ).create_File_Reader ( file_ptr->to_String() );

        std::string entry_point_address =
            file_reader_ptr->get_Meta_Info ( io::File_Reader::ENTRY_POINT );

        std::string base_address =
            file_reader_ptr->get_Meta_Info ( io::File_Reader::BASE_ADDRESS );

        std::cout << boost::format("Entry Point %1s") % entry_point_address
				  << std::endl;

        std::cout << boost::format("Base Address %1s") % base_address
				  << std::endl;

        /**
         * add input filename to output information
         */
        data_ptr->set_Output_Data ( file_ptr );

        /**
         * add file type to meta information
         */
        meta::Meta_Object::ptr_t meta_ptr ( new meta::Meta_Object() );

        meta_ptr->add ( "entry_point_address",
                        entry_point_address,
                        meta::Meta_Object::HEX );

        meta_ptr->add ( "base_address",
                        base_address,
                        meta::Meta_Object::HEX );

        data_ptr->set_Output_Meta_Data ( meta_ptr );

        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Exiting Entry_Point_Detector::process (id=%d)")
                           % m_state_ptr->get_ID() ) );

    }

    void
    Entry_Point_Detector::run ( infrastructure_types::Component_Graph::Data_Map_t* m_input_data )
    {
        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Entering Entry_Point_Detector::run (id=%d)")
                           % m_state_ptr->get_ID() ) );

        std::cout << std::endl
                  << "--------------------------------" << std::endl
                  << boost::format ( "%s(%d) - run" )
            % m_name
            % m_state_ptr->get_ID() << std::endl
                  << "--------------------------------" << std::endl;

        m_state_ptr->run ( this->shared_from_this(),
                           m_input_data );        

        std::cout << "--------------------------------" << std::endl
                  << boost::format ( "%s(%d) - done" )
            % m_name
            % m_state_ptr->get_ID() << std::endl
                  << "--------------------------------" << std::endl
                  << std::endl;

        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Exiting Entry_Point_Detector::run (id=%d)")
                           % m_state_ptr->get_ID() ) );

    }

    infrastructure_types::Data_Source_Base::ptr_t
    Entry_Point_Detector::results (void)
    {
        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Inside Entry_Point_Detector::results (id=%d)")
                           % m_state_ptr->get_ID() ) );

        return m_state_ptr->results();
    }

    void
    Entry_Point_Detector::set_State ( boost::uint32_t mode )
    {
        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Inside Entry_Point_Detector::set_State (id=%d)")
                           % m_state_ptr->get_ID() ) );

        m_state_ptr->switch_State ( mode );
    }

    boost::uint32_t
    Entry_Point_Detector::get_ID (void) const
    {
        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Inside Entry_Point_Detector::get_ID (id=%d)")
                           % m_state_ptr->get_ID() ) );

        return m_state_ptr->get_ID();
    }
    
    infrastructure_types::Component_Data::Input_Token_t::const_iterator
    Entry_Point_Detector::get_Source_List_Begin (void) const
    {
        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Inside Entry_Point_Detector::get_Source_List_Begin (id=%d)")
                           % m_state_ptr->get_ID() ) );

        return m_state_ptr->get_Source_List_Begin ();
    }

    infrastructure_types::Component_Data::Input_Token_t::const_iterator
    Entry_Point_Detector::get_Source_List_End (void) const
    {
        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Inside Entry_Point_Detector::get_Source_List_End (id=%d)")
                           % m_state_ptr->get_ID() ) );

        return m_state_ptr->get_Source_List_End ();
    }

    Entry_Point_Detector&
    Entry_Point_Detector::operator= ( Entry_Point_Detector const& rhs )
    {
        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Entering Entry_Point_Detector::operator= (assignment) (id=%d)")
                           % m_state_ptr->get_ID() ) );

        Entry_Point_Detector temp ( rhs );
        swap ( temp );

        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Exiting Entry_Point_Detector::operator= (assignment) (id=%d)")
                           % m_state_ptr->get_ID() ) );

        return *this;
    }

    void
    Entry_Point_Detector::swap ( Entry_Point_Detector& rhs )
    {
        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Entering Entry_Point_Detector::swap (id=%d)")
                           % m_state_ptr->get_ID() ) );

        m_state_ptr.swap ( rhs.m_state_ptr );

        Trace::write_Trace
            ( TraceArea::COMPONENTS,
              TraceLevel::DETAIL,
              boost::str ( boost::format ( "Exiting Entry_Point_Detector::swap (id=%d)")
                           % m_state_ptr->get_ID() ) );

    }
} /* namespace component */
} /* namespace libreverse */
