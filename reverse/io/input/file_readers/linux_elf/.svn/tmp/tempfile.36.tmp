#ifndef ELF_FILE_HEADER_H_
#define ELF_FILE_HEADER_H_

#include "libreverse/io/Type_Mapper.h"
#include <string>
#include "Elf_Header_Eident.h"
#include "libreverse/io/input/File_Readers/Base_Header.h"
#include "libreverse/io/input/File_Readers/File_Reader.h"

namespace libreverse { namespace elf_module {

    /*!
     * \class Elf_File_Header
     * \date 2003
     * \author Stephen Torri
     *
     * A major thanks to Eric Youngdale and Nick Clifton for the nice readelf utility.
     * All functions take and modified from readelf are noted with a message in
     * their description.
     *
     * ----------------------------------------------------------------------------
     * readelf.c -- display contents of an ELF format file
     *  Copyright 1998, 1999, 2000, 2001, 2002, 2003 Free Software Foundation, Inc.
     *
     *  Originally developed by Eric Youngdale <eric@andante.jic.com>
     *   Modifications by Nick Clifton <nickc@redhat.com>
     *
     *  This file is part of GNU Binutils.
     *-----------------------------------------------------------------------------
     */

    template <boost::uint32_t bitsize>
    class Elf_File_Header : public libreverse::header::Base_Header {
    public:

        friend class Elf_File<bitsize>;

        /* Functions */

        /*!
         * \brief Default Constructor
         */
        Elf_File_Header();

        /*!
         * \brief Default Destructor
         */
        virtual ~Elf_File_Header();

        /*!
         * \brief Return the bit size of this header
         * \return Bit size of header
         */
        virtual boost::uint32_t get_size (void) const;

        /*!
         * \brief Convert the header data into a string representation
         * \return String representation of header data
         */
        virtual std::string to_String (void);

        /*!
         * \brief Find human reable strings in file header
         */
        virtual void get_Text_String ( io_types::Text_Data::data_type* output );

        /*!
         * \brief Convert the bit order of the stored data if host and data
         * endian types differ
         */
        virtual void convert ();

        bool needs_Convert();

        /*!
         * \brief Returns the string representation of the file type (e_type)
         *
         * \return String representation of target file type
         *
         * NOTE: Taken from readelf.c
         */
        std::string const get_File_Type_Meta (void);

        /*!
         * \brief Returns the e_type value
         *
         * \return Value of target file type
         */
        boost::uint16_t get_File_Type_Value (void) const;

        /*!
         * \brief Returns the string representation of the cpu
         * architecutre of the target file (e_machine)
         *
         * \return String representation of the cpu architecture of the
         * target file
         *
         */
        std::string const get_Arch_Type (void);


        /*!
         * \brief Returns the machine name
         * \return String representation of machine name
         * NOTE: Taken from readelf.c
         */
        std::string get_Machine_Name (void);

        /*!
         * \brief Returns the machine flags
         * \return String representation of machine flags
         * NOTE: Taken from readelf.c
         */
        std::string get_Machine_Flags (void);

        /*!
         * \brief Returns the ARM machine flags
         * \return String representation of ARM machine flags
         * NOTE: Taken from readelf.c
         */
        std::string decode_ARM_Machine_Flags (void);

        const boost::uint16_t get_Program_Header_Count (void);

        const typename Type_Mapper<bitsize>::arch_t get_Program_Header_Offset(void);

        const boost::uint16_t get_Section_Header_Count (void);

        const typename Type_Mapper<bitsize>::arch_t get_Section_Header_Offset(void);

        const boost::uint16_t get_Machine_Value (void);

        const boost::uint16_t get_String_Token_Index (void);

        boost::shared_ptr<Elf_Header_Eident> get_Eident (void);

        typename Type_Mapper<bitsize>::arch_t get_Entry (void);

    private:

        std::string get_File_Type_Name (void);

        /* Data */

        /*! \brief  ELF "magic number".
         *
         * The initial bytes mark the file as an object file and provide
         * machine-indepenedent data with which to decode and interpret the
         * file's contents.[ELF Format]
         */
        elf_types::Elf_Header_Eident::ptr_t e_ident;

        /*! \brief  Object file type */
        boost::uint16_t e_type;

        /*! \brief Required architecture for the file */
        boost::uint16_t e_machine;

        /*! \brief ELF version for the file */
        boost::uint32_t e_version;

        /*!
         * \brief This memeber gives the virtual address to which the system
         * first transfer control. If the file has no associated entry
         * point, this member holds zero. [Elf Format]
         */
        typename Type_Mapper<bitsize>::arch_t e_entry;

        /*! \brief  Program header table's file offset in bytes */
        typename Type_Mapper<bitsize>::arch_t e_phoff;

        /*! \brief  Section header table's file offset in bytes */
        typename Type_Mapper<bitsize>::arch_t e_shoff;

        /*! \brief  Processor-specific flags associated with the file */
        boost::uint32_t e_flags;

        /*! \brief  ELF header size in bytes */
        boost::uint16_t e_ehsize;

        /*! \brief  Program header table entry size */
        boost::uint16_t e_phentsize;

        /*!
         * \brief This members holds the number of entries in the program
         * header table (bytes).
         */
        boost::uint16_t e_phnum;

        /*! \brief  Section header table entry size (bytes) */
        boost::uint16_t e_shentsize;

        /*! \brief  Section header table entry count */
        boost::uint16_t e_shnum;

        /*!
         * \brief Section header string table index of the entry associated
         * with the section name string table.
         */
        boost::uint16_t e_shstrndx;

        /* Constants */
        static const boost::uint8_t EI_NIDENT;

        /* Functions */
    };

} /* namespace elf_module */
} /* namespace libreverse */

#include "Elf_File_Header_T.cpp"

#endif /* ELF_FILE_HEADER_H_ */
