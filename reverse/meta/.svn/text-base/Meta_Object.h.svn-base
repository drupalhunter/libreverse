/*  Meta_Object.h

    Copyright (C) 2008 Stephen Torri

    This file is part of Libreverse.

    Libreverse is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published
    by the Free Software Foundation; either version 3, or (at your
    option) any later version.

    Libreverse is distributed in the hope that it will be useful, but
    WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
    General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see
    <http://www.gnu.org/licenses/>.
*/

#ifndef META_OBJECT_H_
#define META_OBJECT_H_

#include <map>
#include <boost/shared_ptr.hpp>
#include <sstream>
#include <iostream>
#include "libreverse/errors/Meta_Exception.h"

namespace libreverse {

  namespace meta {

    class Meta_Object {
    public:

      /*---------------------------*/
      /*         TYPEDEFS          */
      /*---------------------------*/

      /* Hash, Object */
      typedef std::pair < std::string, boost::uint8_t > Data_Pair_t;

      typedef std::map< std::string, Data_Pair_t > Data_t;

      typedef Data_t::iterator iterator;
      typedef Data_t::const_iterator const_iterator;
      typedef Data_t::size_type size_t;
      typedef boost::shared_ptr < Meta_Object > ptr_t;
      typedef boost::shared_ptr < Meta_Object const > const_ptr_t;

      /*---------------------------*/
      /*         CONSTANTS         */
      /*---------------------------*/
      static boost::uint8_t const STRING;
      static boost::uint8_t const HEX;

      /*---------------------------*/
      /*         FUNCTIONS         */
      /*---------------------------*/
      explicit Meta_Object ( void );

      explicit Meta_Object ( Meta_Object const& rhs );

      virtual ~Meta_Object(){}

      Meta_Object& operator= ( Meta_Object const& rhs );

      void swap ( Meta_Object& rhs );

      /**
       * \brief Insert value into data structure if type and value
       * pair do not already exist.
       *
       * (Requires clause)
       * \pre key is not empty
       * \pre value is not empty
       * \pre type is one of the constant values (e.g. STRING or HEX)
       *
       * (Ensures clause)
       * \post key and value pair is stored in data structure
       */
      void add ( std::string key,
		 std::string value,
		 boost::uint8_t type );

      /**
       * meta_ptr contains a list of Meta_Object items to be added
       *
       * (Requires clause)
       * \pre meta_ptr is not null
       * \pre meta_ptr contains 0 or more key and value pairs
       */
      void append ( Meta_Object::const_ptr_t meta_ptr );

      /**
       * \brief Retrieve the data pair value stored at the given position
       *
       * (Requires clause)
       * \pre key is not empty
       * \pre key is present in data structure
       *
       * (Ensures clause)
       * \post value of data pair is not empty
       * \post type of data pair is valid
       */
      Data_Pair_t get_Value ( std::string key ) const;

      /**
       * \brief Returns a iterator to the start of the data structure
       */
      iterator begin (void);

      /**
       * \brief Returns a constant iterator to the start of the data structure
       */
      const_iterator const begin (void) const;

      /**
       * \brief Returns a iterator to the end of the data structure
       */
      iterator end (void);

      /**
       * \brief Returns a constant iterator to the end of the data structure
       */
      const_iterator const end (void) const;

      /**
       * \brief Returns the number of items stored in the data structure
       */
      size_t size (void) const;

      /**
       * \brief Returns a string representing the contents of the data structure
       */
      std::string to_String (void) const;

      inline boost::uint32_t
        convert_To_UInt32 ( std::string str_val ) const
      {
	std::istringstream input ( str_val );
	boost::uint32_t result;
	if ( ! ( input >> result ) )
	  {
	    std::cerr << "Meta_Object::convert_To_UInt32 - failed for string = "
		      << str_val << std::endl;
	    throw errors::Meta_Exception
	      ( errors::Meta_Exception::BAD_CONVERSION );
	  }

	return result;
      }

    private:

      bool is_Valid_Type ( boost::uint8_t type ) const;

      Data_t m_info_map;

    };

  } /* namespace meta */
} /* namespace libreverse */

#endif /* META_OBJECT_H_ */
